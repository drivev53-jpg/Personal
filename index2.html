<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Source Chat</title>
<link rel="icon" href="https://t3.ftcdn.net/jpg/08/63/01/66/360_F_863016640_fdXeQ7Olm2XJv7BulETweOBaRlUg4lLL.jpg">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

<div id="loading" class="fixed inset-0 bg-white flex items-center justify-center text-xl font-bold text-gray-600">
Loading App...
</div>

<div id="app" class="hidden flex-1 flex-col">

<header class="bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-md p-4 flex justify-between">
<div class="flex items-center space-x-3">
<img src="https://t3.ftcdn.net/jpg/08/63/01/66/360_F_863016640_fdXeQ7Olm2XJv7BulETweOBaRlUg4lLL.jpg" class="w-8 h-8 rounded-full">
<span class="font-bold">Open Source Chat</span>
</div>
<div class="space-x-3">
<button id="darkModeToggle">ðŸŒ™</button>
<button id="logoutButton">Reset</button>
</div>
</header>

<div class="flex flex-1 overflow-hidden">

<aside class="w-64 bg-gray-800 text-white p-4 flex flex-col space-y-3">
<button id="newChatButton" class="bg-blue-500 p-2 rounded">New Chat</button>
<ul id="chatList" class="space-y-2"></ul>
<div id="tokenUsage" class="text-sm text-gray-300">Token Usage: 0</div>
</aside>

<main class="flex-1 p-4 flex flex-col overflow-hidden">

<div id="chatArea" class="flex-1 overflow-y-auto space-y-3"></div>

<div class="flex space-x-2 mt-3">
<textarea id="inputArea" class="flex-1 p-2 border rounded" rows="2"></textarea>
<button id="sendButton" class="bg-blue-500 text-white px-4 rounded">Send</button>
<button id="stopButton" class="bg-red-500 text-white px-4 rounded">Stop</button>
</div>

</main>
</div>
</div>

<script>

const AppState = {
chats: [],
activeChatId: null,
settings: {
apiKey: "",
model: "deepseek/deepseek-r1:free",
temperature: 0.7,
maxTokens: 1000,
darkMode: false
},
isGenerating: false,
abortController: null
};

const Storage = {
loadChats: () => JSON.parse(localStorage.getItem("chats")) || [],
saveChats: (chats) => localStorage.setItem("chats", JSON.stringify(chats))
};

const renderSidebar = () => {
const chatList = document.getElementById("chatList");
chatList.innerHTML = AppState.chats.map(chat => `
<li class="cursor-pointer p-2 ${chat.id === AppState.activeChatId ? 'bg-blue-500' : ''}"
onclick="setActiveChat('${chat.id}')">
${chat.title}
</li>`).join('');
};

const renderMessages = () => {
const chatArea = document.getElementById("chatArea");
const activeChat = AppState.chats.find(c => c.id === AppState.activeChatId);
if (!activeChat) return;

chatArea.innerHTML = activeChat.messages.map(msg => `
<div class="${msg.role === 'user' ? 'text-right' : ''}">
<div class="p-3 rounded-lg shadow ${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-white'}">
${marked.parse(msg.content)}
</div>
</div>`).join('');

chatArea.scrollTop = chatArea.scrollHeight;
};

const setActiveChat = (id) => {
AppState.activeChatId = id;
renderSidebar();
renderMessages();
};

const handleNewChat = () => {
const newChat = {
id: Date.now().toString(),
title: "New Chat",
messages: [],
tokenUsage: 0
};
AppState.chats.push(newChat);
AppState.activeChatId = newChat.id;
Storage.saveChats(AppState.chats);
renderSidebar();
renderMessages();
};

const fetchChatResponse = async (inputText) => {
if (!inputText.trim()) return;

const activeChat = AppState.chats.find(c => c.id === AppState.activeChatId);
activeChat.messages.push({ role: "user", content: inputText });
renderMessages();

AppState.abortController = new AbortController();

try {
const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
method: "POST",
headers: {
"Content-Type": "application/json",
Authorization: "Bearer " + AppState.settings.apiKey
},
body: JSON.stringify({
model: AppState.settings.model,
messages: activeChat.messages,
temperature: AppState.settings.temperature,
max_tokens: AppState.settings.maxTokens,
stream: true
}),
signal: AppState.abortController.signal
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

let botMessage = { role: "assistant", content: "" };
activeChat.messages.push(botMessage);

while (true) {
const { done, value } = await reader.read();
if (done) break;
const chunk = decoder.decode(value);
const lines = chunk.split("\n").filter(l => l.startsWith("data:"));
for (let line of lines) {
if (line.includes("[DONE]")) break;
const json = JSON.parse(line.replace("data: ", ""));
const delta = json.choices?.[0]?.delta?.content;
if (delta) {
botMessage.content += delta;
renderMessages();
}
}
}

Storage.saveChats(AppState.chats);

} catch (err) {
console.log(err);
}
};

document.addEventListener("DOMContentLoaded", () => {

AppState.chats = Storage.loadChats();

if (AppState.chats.length === 0) handleNewChat();
else AppState.activeChatId = AppState.chats[0].id;

renderSidebar();
renderMessages();

document.getElementById("newChatButton").addEventListener("click", handleNewChat);

document.getElementById("sendButton").addEventListener("click", () => {
const input = document.getElementById("inputArea");
const text = input.value;
input.value = "";
fetchChatResponse(text);
});

document.getElementById("stopButton").addEventListener("click", () => {
if (AppState.abortController) AppState.abortController.abort();
});

document.getElementById("darkModeToggle").addEventListener("click", () => {
document.body.classList.toggle("bg-gray-900");
document.body.classList.toggle("text-white");
});

document.getElementById("logoutButton").addEventListener("click", () => {
localStorage.clear();
location.reload();
});

document.getElementById("loading").style.display = "none";
document.getElementById("app").style.display = "flex";

});
</script>
</body>
</html>